---
title: "ESM244 Assignment3"
author: "Craig O'Neill"
date: "March 12, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(forecast)
library(tseries)
library(sf)
library(tmap)
```


##Task 3

a)  Create a graph of the decomposed time series data (tuckee_flow).  In text beneath the graph describe the time series data.

```{r}
truckee <- read.csv("truckee_flow-edit.csv")

truckee_ts <- ts(truckee$mean_va, frequency = 12, start = c(2000, 1))

truckee_dc <- decompose(truckee_ts)
acf(truckee_ts)
ggtsdisplay(truckee_ts)
adf_truckee <- adf.test(truckee_ts)
adf_truckee
plot(truckee_dc)
```

This data appears to be additive (why).
The data is stationary appears to be stationary, confirmed using a Dickey-Fuller test which calculates the p-value as less than 0.05, rejecting the null-hypothesis that the data is non-stationary.

There is annual seasonality.

b)  Use either Holt-Winters of ARIMA to forecast Truckee River for 5 years after the final observation.  Visualize the forecasted data in a graph.


First Holt-Winters
```{r}
truckee_hw <- HoltWinters(truckee_ts)
truckee_hw
plot(truckee_hw)

truckee_holtfc <- forecast(truckee_hw, h = 60)
plot(truckee_holtfc)


```


Next ARIMA
```{r}
truckee_pdq <- auto.arima(truckee_ts)
truckee_pdq
```

ARIMA (3,1,4)(0,0,1)

```{r}
truckee_arima <- arima(truckee_ts, order = c(3,1,4), seasonal = list(order = c(0,0,1)))

par(mfrow = c(1,2))
hist(truckee_arima$residuals)
qqnorm(truckee_arima$residuals)

forecast_truckee <- forecast(truckee_arima, h = 60)
plot(forecast_truckee)
```

Plotting in ggPlot

```{r}
truckee_df <- data.frame(forecast_truckee)

View(truckee_df)

truckee_df

dates <- seq.Date(as.Date("2000/1/1"), by = "month", length.out = 297)  
  
ggplot(data = truckee, aes(x=dates, y=mean_va))+
  geom_line()
```

##Task 4 Mapping California's National Parks

```{r}
ca_shape <- st_read(dsn = ".", layer = "california_county_shape_file")

st_crs(ca_shape) <- 4326

np_shape <- st_read(dsn = ".", layer = "nps_boundary")

np_shape <- st_transform(np_shape, "+init=epsg:4326")


canp_shape <- np_shape %>% 
  filter(STATE == "CA") %>%
  filter(UNIT_TYPE == "National Park") %>% 
  select(UNIT_NAME, STATE, UNIT_TYPE, geometry)

  
View(ca_shape)  
plot(canp_shape)

ca_np <- tm_shape(ca_shape)+
  tm_polygons(data = canp_shape$UNIT_NAME,
              title = "California's National Parks",
              fillColor = "Blue")

ca_np_gg <- ggplot(canp_shape)+
  geom_sf(data = ca_shape, aes(fill = STATE), color = "gray58", fill = "gray33")+
  geom_sf(aes(color = UNIT_TYPE, fill = UNIT_TYPE), color = "blue", fill = "orange")+
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank(),
        panel.grid.major = element_line(color = "transparent"))

ca_np_gg


```


###Task 5 LTER Lizards in the Northern Chihuahuan Desert

```{r}
library(VIM)
library(mice)
```


1.  For all lizards at site "CALI", do weights of male and female ault lizards differ significantly?

```{r}

lizard <- read.csv("lter_lizard_pitfall_edited.csv")

lizard_cal <- lizard %>% 
  filter(site == "CALI") %>% 
  select(date, site, sex, weight, tail)

lizard_cal$site <- as.factor(lizard_cal$site)
lizard_cal$tail <- as.factor(lizard_cal$tail)
lizard_cal$sex <- as.factor(lizard_cal$sex)


```


Identify missing cases

```{r}
cc <- lizard_cal[complete.cases(lizard_cal),] #this extra comma tells R to just look at the rows of data.
missings <- lizard_cal[!complete.cases(lizard_cal),]

aggr(lizard_cal, prop = F, numbers = T)

imputed_liz <- mice(lizard_cal, m = 5)
summary(imputed_liz)
```
COmpete the cases using imputed cvalues
```{r}
complete(imputed_liz, action = 2)
```

```{r}
lm_liz <- with(imputed_liz, lm(weight ~ sex))
impute_pooled_liz <- pool(lm_liz)

impute_pooled_liz
summary(impute_pooled_liz)
```

